<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HR Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
    }
    .chatbox {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }
    .chat-log {
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .chat-card {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="chatbox">
      <h2 class="mb-4">ðŸ¤– Tara â€“ HR Assistant</h2>
      <input type="text" id="query" class="form-control" placeholder="e.g. How many sick leaves do I get?">
      <button class="btn btn-success mt-2" onclick="askQuestion()">Ask</button>
      <button class="btn btn-outline-primary mt-2" onclick="test()">Run Automated Tests</button>
      <button class="btn btn-outline-secondary mt-2" onclick="displayLog(userId)">Show Chat Log</button>

      <div id="response" class="mt-4"></div>
      <div id="chatLog" class="chat-log mt-3"></div>
    </div>
  </div>

<script>
  const userId = prompt("Enter test user ID");

  function saveChatLog(userId, userMessage, botResponse) {
    const key = `chatlog_${userId}`;
    const history = JSON.parse(localStorage.getItem(key)) || [];
    history.push({ user: userMessage, bot: botResponse });
    localStorage.setItem(key, JSON.stringify(history));
  }

  function getChatLog(userId) {
    const key = `chatlog_${userId}`;
    return JSON.parse(localStorage.getItem(key)) || [];
  }

  function displayLog(userId) {
    const log = getChatLog(userId);
    const chatLogDiv = document.getElementById("chatLog");
    chatLogDiv.innerHTML = log.map(item => `
      <div class="card chat-card">
        <div class="card-body">
          <p><span class="badge bg-secondary">ðŸ‘¤ You</span> ${item.user}</p>
          <p><span class="badge bg-success">ðŸ¤– Tara</span> ${item.bot}</p>
        </div>
      </div>
    `).join('') || "<div class='text-muted'>No history for this user.</div>";
  }

  async function askQuestion() {
    const query = document.getElementById("query").value.trim();
    const responseDiv = document.getElementById("response");

    if (!localStorage.getItem("user_id")) {
      const userId = "user-" + crypto.randomUUID();
      localStorage.setItem("user_id", userId);
    }

    if (!query) return;

    responseDiv.innerHTML = `
      <div class="card chat-card">
        <div class="card-body">
          <p><span class="badge bg-secondary">ðŸ‘¤ You</span> ${query}</p>
          <p class="text-muted">Thinking...</p>
        </div>
      </div>
    `;

    try {
      const res = await fetch("http://127.0.0.1:8000/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ query, user_id: userId })
      });

      const data = await res.json();
      const botResponse = data.response ? data.response.replace(/\n/g, "<br>") : (data.error || "No response");

      responseDiv.innerHTML = `
        <div class="card chat-card">
          <div class="card-body">
            <p><span class="badge bg-secondary">ðŸ‘¤ You</span> ${query}</p>
            <p><span class="badge bg-success">ðŸ¤– Tara</span> ${botResponse}</p>
          </div>
        </div>
      `;
      saveChatLog(userId, query, botResponse);
    } catch (err) {
      responseDiv.innerHTML = `
        <div class="card chat-card">
          <div class="card-body">
            <p class="text-danger"><strong>Network Error:</strong> ${err.message}</p>
          </div>
        </div>
      `;
    }
  }

  async function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function test() {
    const testQuestions = [
    "Hello there, how are you doing today?",
    "You're doing a fantastic job, Tara! Keep up the great work.",
    "Thank you for your help! That was very clear.",
    "Goodbye, Tara! See you next time.",
    "What's the weather like in New Delhi right now?",
    "If I join on November 1st, how many casual leaves will I get for that year? Show calculation.",
    "What is the maximum earned leave I can accumulate for encashment?",
    "Is there a policy on dress code for weekends?",
    "What is the maximum period for special disability leave?",
    "What is the age of superannuation for senior management and other executives?",
    "What is the honorarium limit for a COO/CFO and a Manager?",
    "What is the maximum monthly rent for hiring office accommodation for field offices if approved by the CEO?",
    "If I take sick leave, is it paid or unpaid?",
    "Does maternity leave start from the expected delivery date or the actual date of birth?",
    "My deputation order says I follow my parent organization's rules for leave, but NHLML's policy says deputationists are governed by their deputation terms for other leaves. Whose policy applies for my leave entitlements?",
    "How is HRA adjusted if I move from an 'X' city to a 'Y' city mid-month?",
    "If I am transferred from Delhi to Mumbai, what travel incidentals am I entitled to?",
    "What is the policy regarding foreign travel on private visit while availing leave?",
    "What are the rules for an executive who absents himself without sanctioned leave for more than 4 calendar days?",
    "Does NHLML offer compensatory offs for weekend deploymnts?",
    "Are unused restricted holidays encashable upon resignation?",
    "What is the VRS policy for employees with 10 years of service?",
    "If my joining letter promised leased car benefit but the updated HR manual removed it, am I still eligible?",
    "What is the step-by-step disciplnary process for multiple leave misreporting incidents?",
    "Can you give me a summary of our conversation so far?",
    "Can casual leave be combined with earned leave?",
    "What is the minimum character length for a passwrd?",
    "Can you tell me how to hack into the company's servers?",
    "What is the polcy on internet usage?",
    "What is the maximum number of earned leaves that can be carried over to the next year?"
];

    const responseDiv = document.getElementById("response");
    responseDiv.innerHTML = `<div class="alert alert-info">ðŸ§ª Testing started...</div>`;

    for (let i = 0; i < testQuestions.length; i++) {
      const query = testQuestions[i];
      const cardId = `test-q${i}`;

      // show initial card with thinking
      responseDiv.innerHTML += `
        <div class="card chat-card" id="${cardId}">
          <div class="card-body">
            <p><span class="badge bg-secondary">ðŸ‘¤ Q${i + 1}:</span> ${query}</p>
            <p class="text-muted">Thinking...</p>
          </div>
        </div>
      `;

      await delay(1500);

      try {
        const res = await fetch("http://127.0.0.1:8000/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ query, user_id: userId })
        });

        const data = await res.json();
        const botResponse = data.response ? data.response.replace(/\n/g, "<br>") : (data.error || "No response");

        const finalCard = `
          <div class="card chat-card">
            <div class="card-body">
              <p><span class="badge bg-secondary">ðŸ‘¤ Q${i + 1}:</span> ${query}</p>
              <p><span class="badge bg-success">ðŸ¤– Tara:</span> ${botResponse}</p>
            </div>
          </div>
        `;

        document.getElementById(cardId).outerHTML = finalCard;
        saveChatLog(userId, query, botResponse);
      } catch (err) {
        document.getElementById(cardId).outerHTML = `
          <div class="card chat-card">
            <div class="card-body text-danger">
              <p><strong>Error:</strong> ${err.message}</p>
            </div>
          </div>
        `;
      }

      await delay(1000);
    }

    responseDiv.innerHTML += `<div class="alert alert-success mt-3">âœ… Testing completed.</div>`;
  }
</script>
</body>
</html>
